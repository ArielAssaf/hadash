---
import { useStoryblokApi } from '@storyblok/astro'
import { t } from '../utils/i18n';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro'
import BaseLayout from '../layouts/BaseLayout.astro'
import Hero from '../storyblok/Hero.astro'
import Values from '../storyblok/Values.astro'
import News from '../storyblok/News.astro'
import Newsletter from '../storyblok/Newsletter.astro'
import TeamGrid from '../storyblok/TeamGrid.astro'
import LegislativeList from '../storyblok/LegislativeList.astro'
import fs from 'node:fs';
import path from 'node:path';
import { newsItems } from '../data/news';

const { lang = 'en' } = Astro.props;

// Try to fetch from Storyblok, fallback to local mockup
let story = null;
try {
  const storyblokApi = useStoryblokApi()
  const { data } = await storyblokApi.get('cdn/stories/home', {
    version: 'draft',
    language: lang === 'en' ? '' : lang,
  })
  story = data.story
  
  // Inject local news items into the Storyblok 'news' component
  if (story?.content?.body) {
    story.content.body = story.content.body.map((blok: any) => {
      if (blok.component === 'news') {
        return {
          ...blok,
          lang: lang,
          title: t(lang, 'latestUpdates'),
          view_all_label: t(lang, 'viewAllNews'),
          view_all_link: getLocalizedPath('/news', lang),
          articles: newsItems.slice(0, 3).map(item => ({
            title: item.title,
            image: { filename: item.image },
            category: 'News',
            description: '',
            link: { cached_url: getLocalizedPath(`/news/story/${item.slug}`, lang) },
            original_url: item.original_url
          }))
        };
      }
      if (blok.component === 'team_grid') {
        return {
          ...blok,
          title: lang === 'he' ? "הצוות שלנו" : (lang === 'ru' ? "Наша команда" : "Our Team"),
          members: [
            { 
              name: lang === 'he' ? "איימן עודה" : "Ayman Odeh", 
              role: lang === 'he' ? "יו\"ר הרשימה" : "List Leader", 
              bio: lang === 'he' ? "עו”ד איימן עודה מוביל את רשימת חד”ש והיה ממנהיגי המאבק להכרה בכפרים הבלתי מוכרים בנגב." : "Advocate for Jewish-Arab partnership and leader of the Hadash list.",
              image: { filename: "http://hadash.org.il/wp-content/uploads/AIMAN.jpg" },
              link: { url: "https://www.facebook.com/AymanOdeh1975" }
            },
            { 
              name: lang === 'he' ? "עאידה תומא-סלימאן" : "Aida Touma-Sliman", 
              role: lang === 'he' ? "חברת כנסת" : "Member of Knesset", 
              bio: lang === 'he' ? "פעילה פמיניסטית בולטת, מייסדת עמותת “נשים נגד אלימות” ועורכת לשעבר של העיתון “אל-אתיחאד”." : "Prominent feminist activist, founder of 'Women Against Violence', and former editor of Al-Ittihad.",
              image: { filename: "http://hadash.org.il/wp-content/uploads/AIDA2.jpg" },
              link: { url: "https://www.facebook.com/aidatuma" }
            },
            { 
              name: lang === 'he' ? "עופר כסיף" : "Ofer Cassif", 
              role: lang === 'he' ? "חבר כנסת" : "Member of Knesset", 
              bio: lang === 'he' ? "ד”ר עופר כסיף הוא מרצה למדע המדינה וחבר הנהגת מק”י וחד”ש." : "Academic and political activist, senior member of CPI and Hadash.",
              image: { filename: "http://hadash.org.il/wp-content/uploads/OFER.jpg" },
              link: { url: "https://www.facebook.com/ofercass/" }
            },
            { 
              name: lang === 'he' ? "יוסף ג’בארין" : "Youssef Jabareen", 
              role: lang === 'he' ? "חבר כנסת לשעבר" : "Former MK", 
              bio: lang === 'he' ? "ד”ר יוסף ג’בארין הוא משפטן ומרצה למשפטים, פעיל בולט לקידום זכויות אדם." : "Legal scholar and expert on human rights and minority rights.",
              image: { filename: "http://hadash.org.il/wp-content/uploads/JABARIN4.jpg" },
              link: { url: "http://www.facebook.com/AlJabha" }
            }
          ]
        };
      }
      return blok;
    });
  }
} catch (e) {
  console.log(`No story found for ${lang} in Storyblok, using local mockup`);
}

const absoluteDir = path.resolve(process.cwd(), '../restructured_site');
// const contentFiles = fs.readdirSync(absoluteDir).map(f => f.replace('.md', '')); // Commenting out to avoid error if dir missing

const mockHero = {
  title: t(lang, 'heroTitle'),
  description: t(lang, 'heroDescription'),
  badge: lang === 'he' ? '' : t(lang, 'officialPortal'),
  buttons: [
    { label: t(lang, 'joinUs'), style: 'primary' },
    { label: t(lang, 'readManifesto'), style: 'secondary' }
  ]
};
---

<BaseLayout lang={lang}>
  {story ? (
    <StoryblokComponent blok={{...story.content, body: story.content.body?.filter((b: any) => b.component !== 'legislative_list')}} />
  ) : (
    <>
      <Hero blok={mockHero} />
      
      <Values blok={{
        title: t(lang, 'coreValues'),
        description: t(lang, 'valuesDescription'),
        columns: [
          { title: t(lang, 'value1Title'), text: t(lang, 'value1Text'), icon: 'public', image: { filename: 'https://lh3.googleusercontent.com/aida-public/AB6AXuB6czdVAdRIYITT1gKKvOr-eqIvh5ZEcO5E8UXFPVlYX3C95Angatef4PRb4Fy90Yk2DRv_117ET7QOuBYvojhjPy0pR3lQnlDNkyrHTyckQe1uo0qHDCTjBCt3oALSRbiG47B8NE_KJ9CYfJsI4ifjuKlr4qrVPFU0_gP_0ae_pfTB6hB6SQKkvnpwmh2B-1isykuGa1fZOh152PH2FFd4eTfrs6gOL20Y7mmMfVXfOkQ__O0ZYTM2FarymW9yimnXaKE2HDRupNV8' } },
          { title: t(lang, 'value2Title'), text: t(lang, 'value2Text'), icon: 'balance', image: { filename: 'https://lh3.googleusercontent.com/aida-public/AB6AXuB4N_ORENr-HXyeuYK49rvVkWdap6VVk8kms0dCntNsYMvxNahq3PESuzc3Ui9seHGDmDANJ9bHd8D8MzYf2HtSt9OVyPdFn4g1V9dOOSMs0d4mYjGxBPQphz75c99N05_IH2SH81AckIccyNZ9PKrblwrvhZJPtRsN9hv4QuK8FALY5Qy_nRJ6NbjAineUUCOAtVZn4fMySUMVHPESZIZXxisupUF_AVH-2RRo4QFSakq_dJAvXU10zIhuSs_sh0x4kt_2ROWc28oV' } },
          { title: t(lang, 'value3Title'), text: t(lang, 'value3Text'), icon: 'diversity_3', image: { filename: 'https://lh3.googleusercontent.com/aida-public/AB6AXuB_V9v31YgWvYcQKrqddajD5P2QMr8VVLLRTT51EPKPT0SkUldCw5KYvfkA-OFonaaAdDIGkcYs7kzjnU6XhK9KLJEs-xCysg3-lKP_S4YWZIEV-t0qTwdf_TXT8EMN4q2hBLskrG7kM-oZfN2_SHq44GJP3YgiLTWWxkx7WJ6Db7F8wdTwteFN9U3vRxHTKCeTTpehdtDCDVCX-0tjjFr8U0XSodjhx5sqEng39PvWBhpYcNdtvjXIckCwEsegFvrMl5gFq02Jy_7Z' } }
        ]
      }} />

      <News blok={{
        title: t(lang, 'latestUpdates'),
        view_all_label: t(lang, 'viewAllNews'),
        view_all_link: getLocalizedPath('/news', lang),
        articles: newsItems.slice(0, 3).map(item => ({
          title: item.title,
          image: { filename: item.image },
          category: 'News',
          description: '',
          link: { cached_url: getLocalizedPath(`/news/story/${item.slug}`, lang) },
          original_url: item.original_url
        }))
      }} lang={lang} />

      <TeamGrid blok={{
        title: lang === 'he' ? "הצוות שלנו" : (lang === 'ru' ? "Наша команда" : "Our Team"),
        members: [
          { 
            name: lang === 'he' ? "איימן עודה" : "Ayman Odeh", 
            role: lang === 'he' ? "יו\"ר הרשימה" : "List Leader", 
            bio: lang === 'he' ? "עו”ד איימן עודה מוביל את רשימת חד”ש והיה ממנהיגי המאבק להכרה בכפרים הבלתי מוכרים בנגב." : "Advocate for Jewish-Arab partnership and leader of the Hadash list.",
            image: { filename: "http://hadash.org.il/wp-content/uploads/AIMAN.jpg" },
            link: { url: "https://www.facebook.com/AymanOdeh1975" }
          },
          { 
            name: lang === 'he' ? "עאידה תומא-סלימאן" : "Aida Touma-Sliman", 
            role: lang === 'he' ? "חברת כנסת" : "Member of Knesset", 
            bio: lang === 'he' ? "פעילה פמיניסטית בולטת, מייסדת עמותת “נשים נגד אלימות” ועורכת לשעבר של העיתון “אל-אתיחאד”." : "Prominent feminist activist, founder of 'Women Against Violence', and former editor of Al-Ittihad.",
            image: { filename: "http://hadash.org.il/wp-content/uploads/AIDA2.jpg" },
            link: { url: "https://www.facebook.com/aidatuma" }
          },
          { 
            name: lang === 'he' ? "עופר כסיף" : "Ofer Cassif", 
            role: lang === 'he' ? "חבר כנסת" : "Member of Knesset", 
            bio: lang === 'he' ? "ד”ר עופר כסיף הוא מרצה למדע המדינה וחבר הנהגת מק”י וחד”ש." : "Academic and political activist, senior member of CPI and Hadash.",
            image: { filename: "http://hadash.org.il/wp-content/uploads/OFER.jpg" },
            link: { url: "https://www.facebook.com/ofercass/" }
          },
          { 
            name: lang === 'he' ? "יוסף ג’בארין" : "Youssef Jabareen", 
            role: lang === 'he' ? "חבר כנסת לשעבר" : "Former MK", 
            bio: lang === 'he' ? "ד”ר יוסף ג’בארין הוא משפטן ומרצה למשפטים, פעיל בולט לקידום זכויות אדם." : "Legal scholar and expert on human rights and minority rights.",
            image: { filename: "http://hadash.org.il/wp-content/uploads/JABARIN4.jpg" },
            link: { url: "http://www.facebook.com/AlJabha" } // Redirecting to general Hadash for Jabareen
          }
        ]
      }} />

      <Newsletter blok={{
        title: t(lang, 'newsletterTitle'),
        description: t(lang, 'newsletterDescription'),
        placeholder: t(lang, 'emailPlaceholder'),
        button_label: t(lang, 'subscribe'),
        badge: t(lang, 'stayConnected')
      }} lang={lang} />
    </>
  )}
</BaseLayout>
