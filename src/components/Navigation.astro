---
import navigation from "../data/navigation.json";
import siteSettings from "../data/site-settings.json";

interface Props {
  lang: string;
}

interface NavigationItem {
  label: string;
  link: string;
}

interface FooterMenu {
  title: string;
  links: NavigationItem[];
}

interface NavigationData {
  [key: string]: {
    menuItems: NavigationItem[];
    footerMenus?: FooterMenu[];
  };
}

interface SiteSettings {
  logoText: string;
  officialPortal: string;
  footerText: string;
  copyrightText: string;
}

interface SiteSettingsData {
  [key: string]: SiteSettings;
}

const { lang } = Astro.props;
const data =
  (navigation as NavigationData)[lang] || (navigation as NavigationData)["en"];
const settings =
  (siteSettings as SiteSettingsData)[lang] ||
  (siteSettings as SiteSettingsData)["en"];
const base = "/hadash";

const getLink = (link: string) => {
  if (link.startsWith("http") || link.startsWith("#")) return link;
  return `${base}${link.startsWith("/") ? link : `/${link}`}`;
};
const currentPath = Astro.url.pathname.replace(new RegExp(`^${base}`), "");
const langPrefixes = ["/he", "/ar", "/ru"];
const getLanguageTarget = (code: string) => {
  let purePath = currentPath;
  for (const prefix of langPrefixes) {
    if (purePath.startsWith(prefix + "/") || purePath === prefix) {
      purePath = purePath.substring(prefix.length);
      break;
    }
  }
  return code === "en"
    ? purePath || "/"
    : `/${code}${purePath.startsWith("/") ? purePath : "/" + purePath}`;
};

const languages = [
  { code: "he", label: "עברית" },
  { code: "ar", label: "العربية" },
  { code: "en", label: "English" },
  { code: "ru", label: "Русский" },
];
---

<header class="fixed top-0 left-0 right-0 z-50 pointer-events-none">
  <nav class="pointer-events-auto">
    <div class="bg-[#E2343A] shadow-xl">
      <div
        class="container mx-auto max-w-7xl px-4 lg:px-8 py-2 md:py-3 flex items-center justify-between"
      >
        <div class="flex items-center gap-8">
          <a
            href={getLink(lang === "en" ? "/" : `/${lang}`)}
            class="flex items-center group"
          >
            <img
              src="https://hadash.org.il/support/wp-content/uploads/2025/11/HadashLogo-1024x294.png"
              alt="Hadash"
              class="h-10 md:h-12 w-auto object-contain brightness-100 transition-all hover:scale-105"
            />
          </a>

          <!-- Desktop Menu -->
          <ul class="hidden lg:flex items-center gap-6">
            {
              data.menuItems.map((item: NavigationItem) => (
                <li>
                  <a
                    href={getLink(item.link)}
                    class="text-sm font-semibold text-white/90 hover:text-white transition-colors py-2 px-1 relative group"
                  >
                    {item.label}
                    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all group-hover:w-full" />
                  </a>
                </li>
              ))
            }
          </ul>
        </div>

        <div class="flex items-center gap-4">
          <!-- Language Switcher -->
          <div class="relative group">
            <button
              class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-white/10 transition-colors text-sm font-bold text-white"
            >
              <span class="material-symbols-outlined text-lg">language</span>
              <span class="uppercase">{lang}</span>
              <span class="material-symbols-outlined text-sm text-white/70"
                >expand_more</span
              >
            </button>

            <div
              class="absolute right-0 top-full mt-2 w-32 bg-white rounded-xl shadow-xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all p-2 flex flex-col gap-1"
            >
              {
                languages.map((l) => (
                  <a
                    href={getLink(getLanguageTarget(l.code))}
                    class={`px-3 py-2 rounded-lg text-sm transition-colors ${lang === l.code ? "bg-[#E2343A] text-white font-bold" : "hover:bg-gray-50 text-gray-600"}`}
                  >
                    {l.label}
                  </a>
                ))
              }
            </div>
          </div>

          <details class="lg:hidden relative">
            <summary class="list-none p-2 text-white/90 hover:text-white cursor-pointer">
              <span class="material-symbols-outlined">menu</span>
            </summary>
            <div class="absolute top-full right-0 mt-2 w-[min(20rem,calc(100vw-2rem))] bg-white rounded-xl shadow-xl border border-gray-100 p-3 z-50">
              <ul class="flex flex-col gap-1">
                {
                  data.menuItems.map((item: NavigationItem) => (
                    <li>
                      <a
                        href={getLink(item.link)}
                        class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 font-semibold"
                      >
                        {item.label}
                      </a>
                    </li>
                  ))
                }
              </ul>
              <div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-1">
                {
                  languages.map((l) => (
                    <a
                      href={getLink(getLanguageTarget(l.code))}
                      class={`px-3 py-2 rounded-lg text-sm text-center transition-colors ${lang === l.code ? "bg-[#E2343A] text-white font-bold" : "text-gray-600 hover:bg-gray-50"}`}
                    >
                      {l.label}
                    </a>
                  ))
                }
              </div>
            </div>
          </details>
        </div>
      </div>
    </div>
  </nav>
</header>
